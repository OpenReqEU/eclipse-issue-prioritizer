<!DOCTYPE html>
<html xmlns:th="http://www.tymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Keywords</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}" />
    <script src="{{ url_for('static', filename='index.js') }}"></script>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
</head>
<body>
	<h1 style="margin-top:10px;margin-bottom:0;">Keywords of {{ assignee_email_address }}</h1>
    <div id="chart"></div>
    <script type="text/javascript">
        var occurrenceData = { {% for key, value in keyword_frequencies.most_common() %}"{{key}}": {{value}},{% endfor %} };
        var keywordSum = 0;
        var chartData = [];
        var TOP_N_KEYWORDS = 25;
        var TOP_N_KEYWORD_FREQUENCY_SUM_THRESHOLD = 0.9;
        var numberOfKeywords = 0;
        var remainderKeywords = [];
        var remainderOccurrences = 0;

        for (var key in occurrenceData) {
            keywordSum += occurrenceData[key];
        }

        function renderDonutChart(chartData) {
            var fullHeight = $(window).height() - $("h1").height();
            fullHeight -= 0.2 * fullHeight;

            var fullWidth = Math.floor(1.6579 * fullHeight);
            var marginSide = 28;
            if (fullWidth > ($(window).width() - marginSide)) {
                fullWidth = ($(window).width() - marginSide);
                fullHeight = Math.floor(fullWidth / 1.6579)
            }

            var donut = donutChart()
                .width(Math.floor(1.6579 * fullHeight))
                .height(fullHeight)
                .cornerRadius(3) // sets how rounded the corners are on each slice
                .padAngle(0.015) // effectively dictates the gap between slices
                .variable('Frequency')
                .category('Keyword');

            d3.select('#chart')
                .datum(chartData) // bind data to the div
                .call(donut); // draw chart in div

            // comment this to show percentages {
            /*
			$("tspan").remove();
			$(".labelName > text").each(function () {
				var text = $(this).text();
				$(this).text(text.replace(":", ""));
			});
			*/
			// }
        }

        $(document).ready(function() {
            var keywordFrequencySum = 0.0;
            for (var key in occurrenceData) {
                if (occurrenceData.hasOwnProperty(key)) {
                    console.log(key + " -> " + occurrenceData[key]);

                    if (++numberOfKeywords >= TOP_N_KEYWORDS) {
                        remainderKeywords.push(key);
                        remainderOccurrences += occurrenceData[key];
                        continue;
                    }

                    var keywordFrequency = occurrenceData[key] / parseFloat(keywordSum);
                    keywordFrequencySum += keywordFrequency;

                    chartData.push({
                        "Keyword": (key.length > 22) ? key.substring(0, 22) + "." : key,
                        "Frequency": keywordFrequency,
                        "Occurrences": occurrenceData[key]
                    });
                }
            }

            if (keywordFrequencySum < TOP_N_KEYWORD_FREQUENCY_SUM_THRESHOLD) {
                for (var i in chartData) {
                    var keywordFrequency = chartData[i]["Frequency"];
                    chartData[i]["Frequency"] = keywordFrequency / keywordFrequencySum * TOP_N_KEYWORD_FREQUENCY_SUM_THRESHOLD;
                }
                keywordFrequencySum = TOP_N_KEYWORD_FREQUENCY_SUM_THRESHOLD;
            }

            if (remainderKeywords.length > 0) {
                var representativeKeywords = (remainderKeywords.length > 3)
                    ? remainderKeywords.slice(0, 3).concat(["..."])
                    : remainderKeywords;
                representativeKeywords = representativeKeywords.map(k => (k.length > 9) ? k.substring(0, 9) + "." : k);

                chartData.push({
                    "Keyword": representativeKeywords.join(", "),
                    "Frequency": 1.0 - keywordFrequencySum
                });
            }

            renderDonutChart(chartData);

            window.addEventListener('resize', function (event) {
                $("#chart").children().remove();
                renderDonutChart(chartData);
            });
        });
    </script>
</body>
</html>
